<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #faebce;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: rgb(255, 239, 248);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            width: 100%;
            max-width: 1200px;
            margin: 2rem;
        }

        .login-form, .main-system {
            text-align: center;
        }

        .login-form h1, .main-system h1 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
        }

        button:hover {
            background: #555;
            transform: translateY(-1px);
        }

        .scanner-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid #ddd;
        }


        .scanner-input {
            font-size: 18px;
            text-align: center;
            background: white;
            border: 2px solid #333;
        }

        .table-container {
            overflow-x: auto;
            margin: 2rem 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 65vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #333;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status-borrowing { color: #666; font-weight: bold; }
        .status-returned { color: #000; font-weight: bold; }
        .status-missing { color: #333; font-weight: bold; }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .export-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            border-left: 4px solid #333;
        }

        .hidden { display: none; }

        .equipment-select {
            min-width: 150px;
        }

        .status-select {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                margin: 0.25rem 0;
            }
        }
        
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js">
    </script>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h1>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
            <div class="form-group">
                <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="password">‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏î</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button onclick="login()">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</button>
            <div id="loginError" style="color: red; margin-top: 1rem;"></div>
        </div>

        <!-- Main System -->
        <div id="mainSystem" class="main-system hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
                <button onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
            </div>

            <!-- Scanner Section -->
            <div class="scanner-section">
                <h3>‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 5 ‡∏´‡∏•‡∏±‡∏Å</h3>
                <input type="text" id="barcodeInput" class="scanner-input" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏¥‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏Ç 5 ‡∏´‡∏•‡∏±‡∏Å" maxlength="5" autofocus>
                <p style="margin-top: 1rem; color: #666;">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢</p>
            </div>

            <!-- Records Table -->
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- Records will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button onclick="clearToday()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button onclick="exportTXT()">Save as TXT</button>
                <button onclick="exportExcel()">Save as XLS</button>
            </div>
        </div>
    </div>

    <script>
        // Equipment options (persistent via localStorage)
        const DEFAULT_EQUIPMENT_OPTIONS = [
            '‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏™', '‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•', '‡πÄ‡∏õ‡∏ï‡∏≠‡∏á', '‡∏•‡∏π‡∏Å‡∏ü‡∏∏‡∏ï‡∏ã‡∏≠‡∏•',
            '‡∏•‡∏π‡∏Å‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πà‡∏ö‡∏≠‡∏•'
        ];
        let equipmentOptions = [];
        const EQUIP_KEY = 'equipmentOptions';

        function loadEquipmentOptions() {
            try {
                const raw = localStorage.getItem(EQUIP_KEY);
                if (!raw) return [...DEFAULT_EQUIPMENT_OPTIONS];
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.every(v => typeof v === 'string')) {
                    return parsed;
                }
            } catch (e) { /* ignore */ }
            return [...DEFAULT_EQUIPMENT_OPTIONS];
        }

        function saveEquipmentOptions() {
            try { localStorage.setItem(EQUIP_KEY, JSON.stringify(equipmentOptions)); } catch (e) { /* ignore */ }
        }

        function addEquipmentInteractive(recordId) {
            const name = (prompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà:') || '').trim();
            if (!name) return;
            const exists = equipmentOptions.some(e => e.toLowerCase() === name.toLowerCase());
            if (exists) { alert('‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
            equipmentOptions.push(name);
            equipmentOptions.sort((a,b)=>a.localeCompare(b));
            saveEquipmentOptions();
            const rec = borrowingRecords.find(r => r.id === recordId);
            if (rec) rec.equipment = name;
            renderRecords();
            saveDataToLocalStorage();
        }

        function deleteSelectedEquipmentInteractive(selectedName) {
            const name = (selectedName || '').trim();
            if (!name) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
            if (!equipmentOptions.includes(name)) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡πà‡∏µ‡∏ô‡∏µ‡πà'); return; }
            if (!confirm(`‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå \"${name}\" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) return;
            equipmentOptions = equipmentOptions.filter(e => e !== name);
            borrowingRecords.forEach(r => { if (r.equipment === name) r.equipment = ''; });
            saveEquipmentOptions();
            renderRecords();
            saveDataToLocalStorage();
        }

        equipmentOptions = loadEquipmentOptions();

// In-memory storage for records (last 37 days)
        let borrowingRecords = [];
        let recordIdCounter = 1; // kept for backward-compat only
        const STORAGE_KEY = 'borrowingDataAll'; // { records: [...] }
        const DAYS_TO_KEEP = 37;

        function genId() {
            if (window.crypto && crypto.getRandomValues) {
                const a = new Uint8Array(16);
                crypto.getRandomValues(a);
                return [...a].map(b=>b.toString(16).padStart(2,'0')).join('');
            }
            return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        }

        // Admin credentials
        const adminCredentials = {
            username: '1',
            password: '1'
        };

        function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
        }

        function formatDateTime(d) {
        const pad = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

function readAllData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return { records: [] };
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed.records)) parsed.records = [];
                return parsed;
            } catch { return { records: [] }; }
        }

function writeAllData(obj) {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ records: obj.records || [] })); } catch {}
        }

        function pruneOldRecords(records) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - DAYS_TO_KEEP + 1);
            const cutoffStr = cutoff.toISOString().slice(0,10);
            return records.filter(r => (r.time && String(r.time).slice(0,10) >= cutoffStr));
        }

function normalizeIds(records) {
            let changed = false;
            const seen = new Set();
            records.forEach(r => {
                if (!r.id || seen.has(String(r.id))) {
                    r.id = genId();
                    changed = true;
                }
                seen.add(String(r.id));
            });
            return changed;
        }

function loadDataFromLocalStorage() {
            const all = readAllData();
            const pruned = pruneOldRecords(all.records || []);
            const changed = normalizeIds(pruned);
            if (changed || pruned.length !== (all.records||[]).length) {
                writeAllData({ records: pruned });
            }
            borrowingRecords = pruned.sort((a,b)=> (a.time>b.time?-1:1));
        }

function saveDataToLocalStorage() {
            const all = readAllData();
            borrowingRecords.forEach(r => { if (!r.id) r.id = genId(); });
            const byId = new Map((all.records||[]).map(r=>[String(r.id),r]));
            borrowingRecords.forEach(r => byId.set(String(r.id), r));
            const merged = Array.from(byId.values());
            writeAllData({ records: pruneOldRecords(merged) });
        }


        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (username === adminCredentials.username && password === adminCredentials.password) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                setupBarcodeScanner();
                errorDiv.textContent = '';
                renderRecords();
            } 
        }

        function logout() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function setupBarcodeScanner() {
            const barcodeInput = document.getElementById('barcodeInput');
            
            barcodeInput.addEventListener('input', function(e) {
                const barcode = e.target.value;
                if (barcode.length === 5 && /^\d{5}$/.test(barcode)) {
                    processBarcode(barcode);
                    e.target.value = '';
                }
            });

            // Only focus on barcode input when clicked
            barcodeInput.addEventListener('click', function() {
                barcodeInput.focus();
            });
        }

        function processBarcode(barcode) {
            const personId = barcode.slice(-5); // Last 5 digits
            const now = new Date();
            const currentTime = formatDateTime(now);
            // prevent duplicate active borrow
            const hasActive = borrowingRecords.some(r => r.personId === personId && r.status !== '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            if (hasActive) { alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
const record = {
                id: genId(),
                personId,
                equipment: '',
                time: currentTime,
                status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà',
                returnTime: '',
                fullBarcode: barcode
            };
            borrowingRecords.unshift(record);
            renderRecords();
            saveDataToLocalStorage();
        }

function ensureRecordId(rec) {
            if (!rec.id) {
                rec.id = genId();
                saveDataToLocalStorage();
            }
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';

            // Group by date with separators
            let lastDate = '';
            borrowingRecords.forEach(record => {
                ensureRecordId(record);
                const d = String(record.time).slice(0,10);
                if (d !== lastDate) {
                    const sep = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 6;
                    cell.style.fontWeight = 'bold';
                    cell.style.background = '#f0f0f0';
                    cell.textContent = `‚Äî‚Äî ${d} ‚Äî‚Äî`;
                    sep.appendChild(cell);
                    tbody.appendChild(sep);
                    lastDate = d;
                }
                const row = tbody.insertRow();
                
                // Person ID
                const idCell = row.insertCell();
                idCell.textContent = record.personId;

                // Equipment dropdown + manage buttons
                const equipmentCell = row.insertCell();
                const equipmentSelect = document.createElement('select');
                equipmentSelect.className = 'equipment-select';
                equipmentSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>';
                equipmentOptions.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq;
                    option.textContent = eq;
                    if (eq === record.equipment) option.selected = true;
                    equipmentSelect.appendChild(option);
                });
                equipmentSelect.onchange = () => updateRecord(record.id, 'equipment', equipmentSelect.value);
                equipmentCell.appendChild(equipmentSelect);

                const btnContainer = document.createElement('span');
                btnContainer.style.display = 'inline-flex';
                btnContainer.style.gap = '6px';
                btnContainer.style.marginLeft = '8px';

                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.title = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà';
                addBtn.style.width = 'auto';
                addBtn.style.padding = '4px 8px';
                addBtn.style.fontSize = '12px';
                addBtn.onclick = () => addEquipmentInteractive(record.id);

                const delBtn = document.createElement('button');
                delBtn.textContent = 'üóë';
                delBtn.title = '‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                delBtn.style.width = 'auto';
                delBtn.style.padding = '4px 8px';
                delBtn.style.fontSize = '12px';
                delBtn.onclick = () => deleteSelectedEquipmentInteractive(equipmentSelect.value);

                btnContainer.appendChild(addBtn);
                btnContainer.appendChild(delBtn);
                equipmentCell.appendChild(btnContainer);

                // Time
                const timeCell = row.insertCell();
                timeCell.textContent = record.time;

                // Status dropdown
                const statusCell = row.insertCell();
                const statusSelect = document.createElement('select');
                statusSelect.className = 'status-select';
                ['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà', '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏´‡∏≤‡∏¢'].forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    if (status === record.status) option.selected = true;
                    statusSelect.appendChild(option);
                });
                statusSelect.onchange = () => updateRecord(record.id, 'status', statusSelect.value);
                statusSelect.className += ` status-${record.status}`;
                statusCell.appendChild(statusSelect);

                // Return time
                const returnTimeCell = row.insertCell();
                returnTimeCell.textContent = record.returnTime || '';

                // Actions
                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.width = 'auto';
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.onclick = () => deleteRecord(record.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function updateRecord(recordId, field, value) {
let record = borrowingRecords.find(r => String(r.id) === String(recordId));
            if (!record) {
                // Fallback: if ids were missing, ensure and retry
                borrowingRecords.forEach(ensureRecordId);
record = borrowingRecords.find(r => String(r.id) === String(recordId));
            }
            if (record) {
                record[field] = value;
                if (field === 'status') {
                    if (value === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß') {
                        record.returnTime = formatDateTime(new Date());
                    } else {
                        record.returnTime = '';
                    }
                }
                // Persist every change, not only status changes
                saveDataToLocalStorage();
                renderRecords();
            }
        }

        function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
borrowingRecords = borrowingRecords.filter(r => String(r.id) !== String(recordId));
                renderRecords();
                saveDataToLocalStorage()
            }
        }

        function clearToday() {
            if (confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const today = getTodayDateString();
                borrowingRecords = borrowingRecords.filter(r => String(r.time).slice(0,10) !== today);
                renderRecords();
                saveDataToLocalStorage();
            }
        }

        function getTodayDate() {
            return getTodayDateString();
        }

        function exportTXT() {
            if (borrowingRecords.length === 0) {
                alert('No records to export!');
                return;
            }

            let content = `SPORTS EQUIPMENT BORROWING LOG\n`;
            const dates = Array.from(new Set(borrowingRecords.map(r=>String(r.time).slice(0,10)))).sort();
            if (dates.length) content += `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dates[0]} ‡∏ñ‡∏∂‡∏á ${dates[dates.length-1]}\n`;
            content += `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(new Date())}\n`;
            content += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${borrowingRecords.length}\n\n`;
            content += `${'='.repeat(80)}\n\n`;

            let lastDate='';
            borrowingRecords.forEach((record, index) => {
                content += `Record ${index + 1}:\n`;
                content += `  Person ID: ${record.personId}\n`;
                content += `  Equipment: ${record.equipment || 'Not selected'}\n`;
                content += `  Time: ${record.time}\n`;
                content += `  Status: ${record.status}\n`;
                content += `  Return Time: ${record.returnTime || 'N/A'}\n`;
                content += `  Full Barcode: ${record.fullBarcode}\n\n`;
            });

            content += `${'='.repeat(80)}\n`;
            content += `End of Report\n`;

            downloadFile(content, `borrowing_log_${getTodayDate().replace(/\//g, '-')}.txt`, 'text/plain');
        }
        
        function exportExcel() {
            if (borrowingRecords.length === 0) {
                alert('No records to export!');
                return;
            }
            const headers = ['Person ID', 'Equipment', 'Time', 'Status', 'Return Time'];
            const rows = [...borrowingRecords].sort((a,b)=> (a.time>b.time?-1:1));
            const aoa = [headers];
            const merges = [];
            let lastDate = '';
            let currentRowIdx = 1; // header at 0
            rows.forEach(rec => {
                const d = String(rec.time).slice(0,10);
                if (d !== lastDate) {
                    aoa.push([`‚Äî‚Äî ${d} ‚Äî‚Äî`]);
                    merges.push({ s: { r: currentRowIdx, c: 0 }, e: { r: currentRowIdx, c: headers.length - 1 } });
                    currentRowIdx++;
                    lastDate = d;
                }
                aoa.push([
                    rec.personId,
                    rec.equipment || 'Not selected',
                    rec.time,
                    rec.status,
                    rec.returnTime || ''
                ]);
                currentRowIdx++;
            });
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!merges'] = merges;
            ws['!cols'] = headers.map(h=>({wch: Math.max(h.length, 20)}));
            // Summary on the right side (next to records)
            const savedAt = formatDateTime(new Date());
            const total = rows.length;
            const missing = rows.filter(r => r.status === '‡∏´‡∏≤‡∏¢').length;
            const summary = [
                ['SUMMARY'],
                [`Saved: ${savedAt}`],
                [`Records: ${total}`],
                [`Missing: ${missing}`]
            ];
            XLSX.utils.sheet_add_aoa(ws, summary, { origin: 'H1' });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Borrowing Log');
            const dates = Array.from(new Set(rows.map(r => String(r.time).slice(0,10)))).sort();
            const fileName = dates.length ? `Borrowing_Log_${dates[0]}_to_${dates[dates.length-1]}.xlsx` : 'Borrowing_Log.xlsx';
            XLSX.writeFile(wb, fileName);
        }


        function exportPDF() {
            if (borrowingRecords.length === 0) {
                alert('No records to export!');
                return;
            }

            // Create a simple HTML representation for PDF
            let htmlContent = `
                <html>
                <head>
                    <title>Sports Equipment Borrowing Log</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; }
                        .header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #333; color: white; }
                        .status-borrowing { color: #666; font-weight: bold; }
                        .status-returned { color: #000; font-weight: bold; }
                        .status-missing { color: #333; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>Sports Equipment Borrowing Log</h1>
                    <div class="header">
                        <p><strong>Date:</strong> ${getTodayDateString()}</p>
                        <p><strong>Generated:</strong> ${formatDateTime(new Date())}</p>
                        <p><strong>Total Records:</strong> ${borrowingRecords.length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Person ID</th>
                                <th>Equipment</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Full Barcode</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            borrowingRecords.forEach(record => {
                htmlContent += `
                    <tr>
                        <td>${record.personId}</td>
                        <td>${record.equipment || 'Not selected'}</td>
                        <td>${record.time}</td>
                        <td class="status-${record.status}">${record.status.toUpperCase()}</td>
                        <td>${record.fullBarcode}</td>
                    </tr>
                `;
            });

            
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Handle Enter key for login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('loginForm').classList.contains('hidden')) {
                login();
            }
        });
        document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !document.getElementById('loginForm').classList.contains('hidden')) {
            login();
            }
        });

        loadDataFromLocalStorage();
    </script>
</body>
</html>