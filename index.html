<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #faebce;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: rgb(255, 239, 248);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            width: 100%;
            max-width: 1200px;
            margin: 2rem;
        }

        .login-form, .main-system {
            text-align: center;
        }

        .login-form h1, .main-system h1 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
        }

        button:hover {
            background: #555;
            transform: translateY(-1px);
        }

        .scanner-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid #ddd;
        }

        .scanner-input {
            font-size: 18px;
            text-align: center;
            background: white;
            border: 2px solid #333;
        }

        .table-container {
            overflow-x: auto;
            margin: 2rem 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #333;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status-borrowing { color: #666; font-weight: bold; }
        .status-returned { color: #000; font-weight: bold; }
        .status-missing { color: #333; font-weight: bold; }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .export-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            border-left: 4px solid #333;
        }

        .hidden { display: none; }

        .equipment-select {
            min-width: 150px;
        }

        .status-select {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                margin: 0.25rem 0;
            }
        }
        
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js">
    </script>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h1>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
            <div class="form-group">
                <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="password">‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏î</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button onclick="login()">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</button>
            <div id="loginError" style="color: red; margin-top: 1rem;"></div>
        </div>

        <!-- Main System -->
        <div id="mainSystem" class="main-system hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
                <button onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
            </div>

            <!-- Scanner Section -->
            <div class="scanner-section">
                <h3>‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 15 ‡∏´‡∏•‡∏±‡∏Å</h3>
                <input type="text" id="barcodeInput" class="scanner-input" placeholder="‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏¥‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πÅ‡∏Å‡∏ô" maxlength="15">
                <p style="margin-top: 1rem; color: #666;">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢</p>
            </div>

            <!-- Records Table -->
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- Records will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button onclick="clearToday()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button onclick="exportTXT()">Save as TXT</button>
                <button onclick="exportExcel()">Save as XLS</button>
            </div>
        </div>
    </div>

    <script>
        // Server API base (served by Express in server.js)
        // If opened via the server (http://localhost:3000), keep ''. If opened as a file, use explicit base.
        const API_BASE = location.origin.startsWith('http') ? '' : 'http://localhost:3000';

        // In-memory state (synced with server)
        let equipmentOptions = [];
        let borrowingRecords = [];

        // Admin credentials (simple client-side check)
        const adminCredentials = { username: '1', password: '1' };

        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateTime(d) {
            const pad = n => String(n).padStart(2,'0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        function datePartFromRecord(rec) {
            if (!rec || !rec.time) return '';
            return String(rec.time).split(' ')[0] || '';
        }

        // API helpers
        async function apiGet(path) {
            const res = await fetch(`${API_BASE}${path}`);
            if (!res.ok) throw new Error('Request failed');
            return res.json();
        }
        async function apiJson(path, method, body) {
            const res = await fetch(`${API_BASE}${path}`, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error('Request failed');
            return res.json();
        }
        async function apiDelete(path) {
            const res = await fetch(`${API_BASE}${path}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Request failed');
            try { return await res.json(); } catch { return { ok: true }; }
        }

        async function loadInitialData() {
            equipmentOptions = await apiGet('/api/equipment');
            borrowingRecords = await apiGet('/api/records');
        }

        async function addEquipmentInteractive(recordId) {
            const name = (prompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà:') || '').trim();
            if (!name) return;
            if (equipmentOptions.some(e => e.toLowerCase() === name.toLowerCase())) {
                alert('‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            equipmentOptions = await apiJson('/api/equipment', 'POST', { name });
            const rec = borrowingRecords.find(r => r.id === recordId);
            if (rec) rec.equipment = name;
            await apiJson(`/api/records/${recordId}`, 'PATCH', { equipment: name });
            renderRecords();
        }

        async function deleteSelectedEquipmentInteractive(selectedName) {
            const name = (selectedName || '').trim();
            if (!name) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
            if (!equipmentOptions.includes(name)) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡πà‡∏µ‡∏ô‡∏µ‡πà'); return; }
            if (!confirm(`‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå "${name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) return;
            equipmentOptions = await apiDelete(`/api/equipment?name=${encodeURIComponent(name)}`);
            // Clear in local state too
            borrowingRecords.forEach(r => { if (r.equipment === name) r.equipment = ''; });
            renderRecords();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            if (username === adminCredentials.username && password === adminCredentials.password) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                setupBarcodeScanner();
                errorDiv.textContent = '';
                await loadInitialData();
                renderRecords();
            } else {
                errorDiv.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            }
        }

        function logout() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function setupBarcodeScanner() {
            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.addEventListener('input', async function(e) {
                const barcode = e.target.value;
                if (barcode.length === 5 && /^\d{5}$/.test(barcode)) {
                    await processBarcode(barcode);
                    e.target.value = '';
                }
            });
            barcodeInput.addEventListener('click', function() { barcodeInput.focus(); });
        }

        async function processBarcode(barcode) {
            const personId = barcode.slice(-5);
            const currentTime = formatDateTime(new Date());
            const payload = {
                personId,
                equipment: '',
                time: currentTime,
                status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà',
                returnTime: '',
                fullBarcode: barcode
            };
            const created = await apiJson('/api/records', 'POST', payload);
            borrowingRecords.unshift(created);
            renderRecords();
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';

            // Sort newest first by time string (YYYY-MM-DD HH:MM:SS)
            const rows = [...borrowingRecords].sort((a, b) => (a.time > b.time ? -1 : a.time < b.time ? 1 : 0));
            let lastDate = '';

            rows.forEach(record => {
                const d = datePartFromRecord(record);
                if (d !== lastDate) {
                    const sep = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 6;
                    cell.style.fontWeight = 'bold';
                    cell.style.background = '#f0f0f0';
                    cell.textContent = `‚Äî‚Äî ${d} ‚Äî‚Äî`;
                    sep.appendChild(cell);
                    tbody.appendChild(sep);
                    lastDate = d;
                }

                const row = tbody.insertRow();
                const idCell = row.insertCell();
                idCell.textContent = record.personId;

                const equipmentCell = row.insertCell();
                const equipmentSelect = document.createElement('select');
                equipmentSelect.className = 'equipment-select';
                equipmentSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>';
                equipmentOptions.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq;
                    option.textContent = eq;
                    if (eq === record.equipment) option.selected = true;
                    equipmentSelect.appendChild(option);
                });
                equipmentSelect.onchange = () => updateRecord(record.id, 'equipment', equipmentSelect.value);
                equipmentCell.appendChild(equipmentSelect);

                const btnContainer = document.createElement('span');
                btnContainer.style.display = 'inline-flex';
                btnContainer.style.gap = '6px';
                btnContainer.style.marginLeft = '8px';

                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.title = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà';
                addBtn.style.width = 'auto';
                addBtn.style.padding = '4px 8px';
                addBtn.style.fontSize = '12px';
                addBtn.onclick = () => addEquipmentInteractive(record.id);

                const delBtn = document.createElement('button');
                delBtn.textContent = 'üóë';
                delBtn.title = '‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                delBtn.style.width = 'auto';
                delBtn.style.padding = '4px 8px';
                delBtn.style.fontSize = '12px';
                delBtn.onclick = () => deleteSelectedEquipmentInteractive(equipmentSelect.value);

                btnContainer.appendChild(addBtn);
                btnContainer.appendChild(delBtn);
                equipmentCell.appendChild(btnContainer);

                const timeCell = row.insertCell();
                timeCell.textContent = record.time;

                const statusCell = row.insertCell();
                const statusSelect = document.createElement('select');
                statusSelect.className = 'status-select';
                ['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà', '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏´‡∏≤‡∏¢'].forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === record.status) option.selected = true;
                    statusSelect.appendChild(option);
                });
                statusSelect.onchange = () => updateRecord(record.id, 'status', statusSelect.value);
                statusCell.appendChild(statusSelect);

                const returnTimeCell = row.insertCell();
                returnTimeCell.textContent = record.returnTime || '';

                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.width = 'auto';
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.onclick = () => deleteRecord(record.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        async function updateRecord(recordId, field, value) {
            const record = borrowingRecords.find(r => r.id === recordId);
            if (!record) return;
            record[field] = value;
            if (field === 'status') {
                if (value === '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß') {
                    record.returnTime = formatDateTime(new Date());
                } else {
                    record.returnTime = '';
                }
            }
            const updated = await apiJson(`/api/records/${recordId}`, 'PATCH', record);
            // Sync in place
            const idx = borrowingRecords.findIndex(r => r.id === recordId);
            if (idx !== -1) borrowingRecords[idx] = updated;
            renderRecords();
        }

        async function deleteRecord(recordId) {
            if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            await apiDelete(`/api/records/${recordId}`);
            borrowingRecords = borrowingRecords.filter(r => r.id !== recordId);
            renderRecords();
        }

        async function clearToday() {
            if (!confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            const day = getTodayDateString();
            await apiDelete(`/api/records?day=${encodeURIComponent(day)}`);
            borrowingRecords = borrowingRecords.filter(r => datePartFromRecord(r) !== day);
            renderRecords();
        }

        function exportTXT() {
            if (borrowingRecords.length === 0) { alert('No records to export!'); return; }
            let content = `SPORTS EQUIPMENT BORROWING LOG\n`;
            content += `Generated: ${formatDateTime(new Date())}\n`;
            content += `Total Records: ${borrowingRecords.length}\n\n`;
            content += `${'='.repeat(80)}\n\n`;
            const rows = [...borrowingRecords].sort((a,b)=> (a.time>b.time?-1:1));
            let lastDate='';
            rows.forEach((record, index) => {
                const d = datePartFromRecord(record);
                if (d!==lastDate){ content += `-- ${d} --\n`; lastDate=d; }
                content += `Record ${index + 1}:\n`;
                content += `  Person ID: ${record.personId}\n`;
                content += `  Equipment: ${record.equipment || 'Not selected'}\n`;
                content += `  Time: ${record.time}\n`;
                content += `  Status: ${record.status}\n`;
                content += `  Return Time: ${record.returnTime || 'N/A'}\n`;
                content += `  Full Barcode: ${record.fullBarcode}\n\n`;
            });
            content += `${'='.repeat(80)}\nEnd of Report\n`;
            downloadFile(content, `borrowing_log.txt`, 'text/plain');
        }

        function exportExcel() {
            if (borrowingRecords.length === 0) { alert('No records to export!'); return; }
            const headers = ['Person ID', 'Equipment', 'Time', 'Status', 'Return Time'];
            const rows = [...borrowingRecords].sort((a,b)=> (a.time>b.time?-1:1));
            const aoa = [headers];
            const merges = [];
            let lastDate = '';
            let currentRowIdx = 1; // because headers at row 0
            rows.forEach(rec => {
                const d = datePartFromRecord(rec);
                if (d !== lastDate) {
                    aoa.push([`‚Äî‚Äî ${d} ‚Äî‚Äî`]);
                    // merge A..E for this separator row
                    merges.push({ s: { r: currentRowIdx, c: 0 }, e: { r: currentRowIdx, c: headers.length - 1 } });
                    currentRowIdx++;
                    lastDate = d;
                }
                aoa.push([
                    rec.personId,
                    rec.equipment || 'Not selected',
                    rec.time,
                    rec.status,
                    rec.returnTime || ''
                ]);
                currentRowIdx++;
            });
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!merges'] = merges;
            // Column widths
            const colWidths = headers.map((h,i)=>({wch: Math.max(h.length, 20)}));
            ws['!cols'] = colWidths;
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Borrowing Log');
            const fileName = `Borrowing_Log_${getTodayDateString()}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Handle Enter key for login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('loginForm').classList.contains('hidden')) {
                login();
            }
        });
    </script>
</body>
</html>